name: Reusable Docker Build

on:
  workflow_call:
    inputs:
      registry:
        description: 'Container registry URL'
        required: false
        type: string
        default: 'ghcr.io'
      image_name:
        description: 'Image name (defaults to repository name)'
        required: false
        type: string
        default: ''
      platforms:
        description: 'Comma-separated list of platforms to build'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64'
      push:
        description: 'Whether to push the image'
        required: false
        type: boolean
        default: true
      context:
        description: 'Build context path'
        required: false
        type: string
        default: '.'
      dockerfile:
        description: 'Dockerfile path'
        required: false
        type: string
        default: 'Dockerfile'
      cache_scope:
        description: 'Cache scope prefix'
        required: false
        type: string
        default: ''
    outputs:
      image_url:
        description: 'Full image URL with digest'
        value: ${{ jobs.merge.outputs.image_url }}
      image_tag:
        description: 'Image tag version'
        value: ${{ jobs.merge.outputs.image_tag }}
      digest:
        description: 'Image digest'
        value: ${{ jobs.merge.outputs.digest }}
    secrets:
      token:
        description: 'GitHub token for authentication'
        required: false

env:
  REGISTRY: ${{ inputs.registry }}
  IMAGE_NAME: ${{ inputs.image_name || github.repository }}

jobs:
  prepare:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      platforms: ${{ steps.platforms.outputs.matrix }}
    steps:
      - name: Create platform matrix
        id: platforms
        run: |
          # Convert comma-separated string to JSON array
          platforms=$(echo "${{ inputs.platforms }}" | jq -Rc 'split(",") | map(gsub("^\\s+|\\s+$";""))')
          echo "matrix=$platforms" >> $GITHUB_OUTPUT

  build:
    name: Build ${{ matrix.platform }}
    needs: prepare
    runs-on: ${{ matrix.platform == 'linux/arm64' && github.event.repository.visibility == 'public' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    permissions:
      packages: write
      contents: read
    strategy:
      fail-fast: false
      matrix:
        platform: ${{ fromJSON(needs.prepare.outputs.platforms) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive 

      - name: Prepare Platform Pair
        run: |
          platform=${{ matrix.platform }}
          echo "PLATFORM_PAIR=${platform//\//-}" >> $GITHUB_ENV

      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-

      - name: Set up QEMU
        if: matrix.platform == 'linux/arm64' && github.event.repository.visibility != 'public'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        if: inputs.push
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.token || secrets.GITHUB_TOKEN }}

      - name: Build and Push by Digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          outputs: type=image,name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true,push=${{ inputs.push }}
          cache-from: type=gha,scope=${{ inputs.cache_scope }}${{ github.ref_name }}-${{ env.PLATFORM_PAIR }}
          cache-to: type=gha,scope=${{ inputs.cache_scope }}${{ github.ref_name }}-${{ env.PLATFORM_PAIR }},mode=max

      - name: Export Digest
        if: inputs.push
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"

      - name: Upload Digest
        if: inputs.push
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ env.PLATFORM_PAIR }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  merge:
    name: Create Manifest
    runs-on: ubuntu-latest
    needs: build
    if: inputs.push
    permissions:
      packages: write
      contents: read
    outputs:
      image_url: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.merge.outputs.digest }}
      image_tag: ${{ steps.meta.outputs.version }}
      digest: ${{ steps.merge.outputs.digest }}
    steps:
      - name: Download Digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable=${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.token || secrets.GITHUB_TOKEN }}

      - name: Create Manifest List and Push
        id: merge
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create $(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON") \
            $(printf '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@sha256:%s ' *)
          echo "digest=$(cat $(ls | head -1) | xargs -I {} echo sha256:{})" >> $GITHUB_OUTPUT

      - name: Inspect Image
        run: |
          docker buildx imagetools inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
